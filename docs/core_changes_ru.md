# Журнал изменений ядра — инкремент 1

Дата: 2025-10-28
Автор: Agent Mode

Цель инкремента: начать устранение критичных пунктов из docs/core_audit_ru.md без изменения поведенческих правил слоёв перевода, сфокусировавшись на устойчивости ядра и корректности метрик.

Изменения
1) TranslationEngine: восстановление после ошибок и reset()
- Файл: lib/src/core/translation_engine.dart
- Что сделано:
  - В translate(...) заменён шаблон try/catch на try/catch/finally: движок всегда возвращается в состояние ready, если не происходит dispose. Ошибки публикуются через errorStream, но состояние error не удерживается.
  - Добавлен публичный метод reset(): очищает lastError и переводит движок в ready (если не disposed).
- Причина: по аудиту движок «залипал» в состоянии error после единичной ошибки, блокируя дальнейшую работу.
- Риск/влияние: минимальный, совместимость API сохранена. Поведение после ошибки теперь «мягкое»: новая попытка перевода возможна без принудительной переинициализации.

2) LayerAdapter: включена обёртка метрик и валидации слоёв
- Файл: lib/src/core/layer_adapters.dart
- Что сделано: вместо прямого вызова _layer.process(...) используется _layer.processWithMetrics(...), чтобы задействовать валидацию входа и сбор метрик времени/статистики.
- Причина: по аудиту метрики слоёв не собирались и проверки входных параметров обходились, что ухудшало наблюдаемость и надёжность.
- Риск/влияние: ожидаемое улучшение диагностики; поведение слоёв не меняется функционально, добавляется проверка входа и точные тайминги.

Валидация
- До изменений: flutter test — 141 passed, 7 skipped, 3 failed (несвязанные с текущим инкрементом тесты односимвольного вывода).
- После изменений: flutter test — 141 passed, 7 skipped, 3 failed (тот же набор падений; целевые правки касались ядра и метрик, сознательно не правили поведение слоёв).

Оценка и дальнейшие шаги
- Инкремент адресует два критичных пункта из плана: восстановление ядра после ошибки и корректное включение метрик слоёв.
- Следующие приоритеты (из core_audit_ru.md):
  - Согласовать токенизацию между PreProcessingLayer и DictionaryLayer (поддержка нелатинских алфавитов, повторное использование токенов контекста).
  - Улучшить I/O JSONL: пакетная/атомарная запись (tmp+rename), блокировки при записи.
  - Реализовать базовый n-gram поиск во фразовом слое (минимальный bi-/tri-gram).

---

# Журнал изменений ядра — инкремент 2

Дата: 2025-10-28
Автор: Agent Mode

Цель инкремента: согласовать токенизацию DictionaryLayer с PreProcessingLayer и расширить fallback-токенизацию для нелатиницы; обеспечить безопасную реконструкцию текста без потери исходных пробелов и пунктуации.

Изменения
1) DictionaryLayer: повторное использование токенов предобработки
- Файл: lib/src/layers/dictionary_layer.dart
- Что сделано:
  - В process(...) вместо принудительной повторной токенизации используется `preprocessing_tokens` из контекста, если они есть. Это устраняет рассогласование слоёв и повышает качество.
  - Для случая отсутствия токенов предобработки расширена локальная токенизация: латиница, кириллица, CJK, цифры, апострофы и дефисы.

2) Безопасная реконструкция текста
- Добавлен метод `_reconstructFromOriginal(...)`, который собирает результат поверх исходной строки по позициям токенов. Это сохраняет оригинальные пробелы/пунктуацию и меняет только реально переведённые слова.
- process(...) выбирает реконструкцию: при наличии preproc-токенов — безопасная сборка из оригинала; иначе — прежняя локальная сборка.

Причина
- По аудиту слои расходились в определении «слова»; DictionaryLayer работал только с ASCII и терял часть языков. Также повторная токенизация ломала исходную верстку/капитализацию.

Влияние и риск
- Позитивное: лучшая поддержка языков, предсказуемость, сохранение форматирования. Минимальные риски регрессий.

Валидация
- До/после изменений: `flutter test` — 141 passed, 7 skipped, 3 failed (те же тесты односимвольного вывода, не связанные с данным инкрементом).

Следующие шаги
- Улучшить I/O JSONL (атомарная запись и батчи).
- Реализовать простой n-gram в PhraseTranslationLayer.

---

# Журнал изменений ядра — инкремент 3

Дата: 2025-10-28
Автор: Agent Mode

Цель инкремента: оптимизировать I/O слоя данных (атомарная и пакетная запись JSONL) и добавить базовый n-gram-поиск во фразовом слое.

Изменения
1) FileStorageService: атомарные перезаписи и примитивные файловые блокировки
- Файл: lib/src/storage/file_storage.dart
- Что сделано:
  - rewriteJsonLines теперь пишет во временный файл (.tmp) и переименовывает в целевой (tmp + rename). Это помогает избежать частичной записи.
  - Добавлена best-effort блокировка через .lock-файл на время записи (конкурентная запись разных процессов реже портит данные).
  - appendJsonLine обёрнут в ту же блокировку.

2) DictionaryRepository и PhraseRepository: пакетные upsert-операции
- Файлы: lib/src/data/dictionary_repository.dart, lib/src/data/phrase_repository.dart
- Что сделано:
  - Добавлены методы addTranslationsBulk(...) и addPhrasesBulk(...), группирующие изменения по языковой паре и выполняющие одну файловую запись на группу.
  - Обычные addTranslation/addPhrase теперь используют bulk под капотом (для единичного элемента), чтобы унифицировать путь записи.

3) Импортёры слов и фраз: переход на bulk
- Файлы: lib/src/tools/dictionary_importer.dart, lib/src/tools/phrase_importer.dart
- Что сделано: CSV/JSON/JSONL-импорты копят записи в памяти и вызывают соответствующий bulk-метод репозитория, уменьшая асимптотику (с O(n^2) до O(n)).

4) PhraseTranslationLayer: базовый n-gram поиск
- Файл: lib/src/layers/phrase_translation_layer.dart
- Что сделано:
  - При отсутствии полного exact-совпадения слой выполняет поиск фразовых n-грамм (от длинных к коротким) по предобработанным токенам, избегая перекрытий, и собирает результат поверх оригинального текста по позициям токенов (сохранение пробелов/пунктуации).
  - Confidence учитывает исходный confidence записи и длину n-граммы.

Валидация
- Прогон `flutter test`: 141 passed, 7 skipped, 3 failed (односимвольные тесты из словарного слоя по-прежнему не в фокусе текущего инкремента).
- Компиляция — успешно.

Промежуточная проверка модулей (логическая)
- core/TranslationEngine: корректный возврат в ready после ошибок; есть reset(); потокобезопасности очередей пока нет (запланировано отдельно).
- core/TranslationPipeline: состояние обновляется (processing → completed); возможно, стоит возвращать idle после завершения — вынесено в дальнейшие задачи.
- layers/PreProcessingLayer: токенизация многоязычная; сохраняет позиции — используется при реконструкции.
- layers/DictionaryLayer: теперь использует preproc-токены и умеет fallback-токенизацию для нелатиницы; реконструкция безопасная при наличии токенов.
- layers/PhraseTranslationLayer: добавлен n-gram; безопасная реконструкция; приоритизация длинных фраз.
- layers/Grammar/WordOrder/PostProcessing: без изменений в этом инкременте; отмеченные ранее риски (упрощённые правила) остаются.
- data/*Repository: теперь атомарная запись + bulk; конкурентная запись защищена .lock-файлами (best-effort), но для crash-safe журналирования нужны дополнительные механизмы — за рамками текущего шага.
- tools/*Importer: переход на bulk; отчётность об ошибках без изменений.
- utils/CacheManager: не затрагивался; интеграция ключей у репозиториев осталась прежней (точечные set для exact-хитов).

Проверка актуальности задач из плана
- «Атомарная запись и батчи для JSONL» — выполнено и актуально (оставить наблюдение за конкуренцией и возможной доработкой lock-механизма).
- «Базовый n-gram для фраз» — выполнено (дальнейшая доработка: overlapping resolution с весами, контекст/категории).
- «Согласовать токенизацию словаря» — выполнено в предыдущем инкременте (актуально оставить, как достигнуто).
- «Грамматика/порядок слов — доработка правил» — всё ещё нужно; не решено здесь.
- «Наблюдаемость/метрики/трейсинг» — не сделано; остаётся актуально.
- «Кэш: ключи, TTL, метрики» — частично: репозитории обновляют exact-хиты; общая стратегия ключей и размеров — ещё актуальна.
- «Очередь/ограничитель параллелизма для translate» — не сделано; актуально.

Итог
- Два пункта закрыты (I/O и n-gram). Дальше — перерыв на проверку общей работоспособности: кодовая логическая проверка модулей выше проведена, критичных проблем не выявлено; открытые риски отмечены. После подтверждения продолжим с задачами наблюдаемости, кэшей и грамматических правил.

