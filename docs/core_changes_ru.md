# План работ по аудиту ядра (единый список с статусами)

Дата: 2025-10-28
Автор: Agent Mode

Суть пунктов сохранена дословно. Для каждого пункта указаны: статус, сделанное (если есть), шаги реализации (для оставшегося), тесты/критерии. ✔ — выполнено; ◑ — частично; ✖ — не сделано.

---

## Критичные/блокирующие

1) Потеря работоспособности после ошибки: TranslationEngine.translate при исключении ставит state=error и оставляет его навсегда; дальнейшие вызовы бросают (нет восстановления/auto-reset/try-finally для возврата в ready).
- Статус: ✔
- Сделано: try/catch/finally, возврат в ready; публичный reset(); публикация ошибок в errorStream (инкремент 1).
- Тесты/критерии: после исключения state=ready; следующий translate успешен без реинициализации.

2) Состояние и конкурентность: translate не поддерживает параллелизм (второй вызов в processing приведет к исключению). Нет очереди/ограничителя/канселяции/таймаутов на запрос.
- Статус: ◑
- Сделано: сериализация вызовов translate (инкремент 4); rate limiting и внутренняя очередь (инкремент 5).
- Шаги реализации: CancellationToken; timeout per request; ограничение длины очереди и политика drop/timeout; конфиг через EngineConfig.
- Тесты/критерии: отсутствие гонок под нагрузкой; корректная отмена/таймаут; метрики ожиданий.

3) LayerAdapter не использует BaseTranslationLayer.processWithMetrics: метрики и валидация слоя обходятся, debug/статистика слоев — номинальные.
- Статус: ✔
- Сделано: вызов заменён на processWithMetrics; метрики и валидация включены (инкремент 1).
- Тесты/критерии: у слоёв измеряются тайминги/счётчики, без регрессий поведения.

4) Сильное рассогласование токенизации: PreProcessingLayer поддерживает латиницу/кириллицу/СJK, а DictionaryLayer токенизирует только [A-Za-z]; не-латинские слова не переводятся, конвейер несогласован.
- Статус: ✔
- Сделано: реюз preproc-токенов; расширенный fallback-токенайзер; безопасная реконструкция текста (инкремент 2).
- Тесты/критерии: RU/CJK кейсы переводятся; сохраняются пробелы/пунктуация.

5) PhraseTranslationLayer умеет только exact-lookup; N-граммы/фаззимэтч отсутствуют — большинство реальных фраз не обрабатываются.
- Статус: ✔
- Сделано: базовый n-gram (bi/tri), приоритет длинных, без перекрытий; безопасная реконструкция; вклад длины в confidence (инкремент 3).
- Тесты/критерии: фразы без exact переводятся без артефактов.

6) JSONL-репозитории: addTranslation/addPhrase перезаписывают весь файл на КАЖДУЮ запись (O(n²) на импорт), без файловых блокировок/атомарности — высокие риски порчи данных и немасштабируемо.
- Статус: ✔
- Сделано: bulk upsert; tmp+rename (atomic); best-effort lock; импортёры переключены на bulk (инкремент 3).
- Тесты/критерии: импорт O(n); отсутствие частичных файлов при конкурентной записи.

7) Потенциальная некомпилируемость: WordOrderLayer использует Iterable.firstOrNull без импорта расширений — выпадет ошибка сборки.
- Статус: ✔
- Сделано: убрана зависимость от расширения; реализован безопасный поиск первого элемента вручную.
- Тесты/критерии: проект компилируется; поведение эквивалентно/безопасно.

8) CLI/пакетирование: в репозитории нет pubspec/entrypoint (translate_engine.dart), docs указывают на команды, которых нет как исполняемый биндинг; сборка/запуск CLI под вопросом.
- Статус: ✔
- Сделано: добавлен executables в pubspec.yaml (translate_engine -> bin/translate_engine.dart); бинарь присутствует; поддержаны команды db/import/export/validate.
- Тесты/критерии: e2e запуск CLI согласно докам.

9) Конфигурация EngineConfig фактически не применяется: initialize принимает Map, _applyConfig — заглушка; большинство флагов (TTL, лимиты, логгирование, rate limit, quality) не задействованы.
- Статус: ◑
- Сделано: применены конфиги к кэшу/логам/метрикам/лимиту частоты; добавлены параметры очереди (max_pending) и таймаут перевода (timeouts.translate_ms); метрики отражают queue/timeout.
- Шаги реализации: добавить cancellation token и внедрить quality-профили; расширить применение конфигов в слоях.
- Тесты/критерии: изменение конфигов влияет на поведение и метрики.

---

## Серьёзные проблемные зоны

10) Состояния pipeline: после успешной обработки состояние остается completed (не idle), наблюдателям трудно трактовать «готовность». 
- Статус: ✔
- Шаги реализации: явная финализация шага → idle; события начала/конца шага.
- Тесты/критерии: после шага — idle; корректные уведомления.

11) Silence-fail в _initializeDefaultLayers: любые проблемы заглушаются, слои не регистрируются, а перевод молча вернёт originalText с confidence=0.5.
- Статус: ◑
- Сделано: добавлено подробное логирование и сбор ошибок при инициализации каждого слоя; при отсутствии слоёв кидается явная ошибка StateError.
- Шаги реализации: добавить конфиг для degraded-режима (продолжать при частичных сбоях) и документировать поведение.
- Тесты/критерии: нет «тихих» сбоев; при пустом наборе слоёв — явная ошибка.

12) Достоверность грамматики/порядка слов: правила упрощены до прототипа, отдельные regex/replacement выглядят некорректно.
- Статус: ◑
- Сделано: отключены рискованные дефолты в Grammar/WordOrder (инкремент 4).
- Шаги реализации: вынести язык-специфичные правила во внешние JSONL + схема и тесты.
- Тесты/критерии: правила проходят schema validation и unit-тесты.

13) PostProcessingLayer правит пунктуацию/регистр эвристически, может портить тексты (особенно FR, кавычки, NBSP).
- Статус: ✖
- Шаги реализации: язык-специфичные правила; опции отключения шагов.
- Тесты/критерии: FR/ES/RU без навязанных точек и искажений.

14) CacheManager: фактические хиты/промахи не отражают реальность; TTL/eviction не применяются к generic; метрики заглушки.
- Статус: ✔
- Сделано: единая стратегия ключей ('dict:'/'phrase:'), hot-path кэширование во всех операциях поиска/точных хитов и списков; LRU+TTL и метрики задействованы; конфиг лимитов/TTL применяется.
- Тесты/критерии: ожидаемый hit-rate; корректный TTL/eviction.

15) Память: in-memory индексы для каждого langPair без выгрузки/ограничений; рост памяти без контроля.
- Статус: ✖
- Шаги реализации: лимиты/квоты; lazy-loading/segmentation/sharding; политики выгрузки.
- Тесты/критерии: контролируемое потребление памяти при росте пар.

16) Импорт: CSV парсинг на split(delimiter), нет отчёта и транзакционности.
- Статус: ✔
- Сделано: реализован CSV-парсер с поддержкой кавычек и экранирования (двойные кавычки), таб-разделителя; отчёт ошибок собирается построчно; запись транзакционная (bulk + tmp+rename).
- Тесты/критерии: «грязные» CSV корректно обрабатываются; подробная отчётность.

17) Хранилище: readAsLinesSync() при загрузке — блокирующее; rewriteJsonLines без fsync/atomic повсеместно; нет блокировок.
- Статус: ◑
- Сделано: tmp+rename + lock (инкремент 3).
- Шаги реализации: потоковое чтение JSONL; fsync на критических путях; усилить lock-механику.
- Тесты/критерии: устойчивость к I/O сбоям и большим файлам.

18) Безопасность загрузок: DbCommand тянет из GitHub raw без подписи/хэшей; нет retry/backoff.
- Статус: ◑
- Сделано: в DbCommand добавлены HTTPS-только, allowlist для github* (с опцией --allow-any-source), retry/backoff и верификация SHA-256 по опции --sha256; атомарная запись (tmp+rename).
- Шаги реализации: поддержка подписи/хэша из index.json, более строгий pinning и политика источников.
- Тесты/критерии: подмена/битые файлы отклоняются; корректные проходят.

19) Тестовая база: часть тестов skip; нет тестов на большие данные/конкурентный доступ/восстановление/атомарность/нелатиницу.
- Статус: ✖
- Шаги реализации: добавить недостающие unit/integration; property-based для парсеров; нагрузочные.
- Тесты/критерии: покрытие критичных сценариев; стабильные прогоны.

---

## Логические несоответствия и дыры

20) Семантика TextToken: в DictionaryLayer «normalized» используется для текста перевода, а флаг wasNormalized сравнивает с original — путаница между «нормализацией» и «переводом».
- Статус: ✖
- Шаги реализации: развести понятия в модели; обновить поля/флаги и места использования.
- Тесты/критерии: однозначная модель данных на этапах пайплайна.

21) Confidence: Pipeline считает по debugInfo (cacheHits/itemsProcessed), но слои не заполняют поля; фолбек 0.5 вводит в заблуждение.
- Статус: ◑
- Сделано: новая формула confidence: 40% успешность слоёв, 40% доля модифицированных слоёв, 20% плотность изменений (modifications/items), +10% бонус за cache hit rate; ограничение 0..1.
- Шаги реализации: дополнительно учесть покрытие текста и источник перевода (словарь/фразы/N-gram) — далее.
- Тесты: синтетические кейсы дают ожидаемые значения.

22) hasDataAccess всегда true — маскирует проблемы доступа к данным.
- Статус: ✔
- Сделано: hasDataAccess в pipeline проверяет доступность корневого каталога storage у репозиториев; метрики отражают состояние.
- Тесты/критерии: недоступный storage отражается флагом/ошибками.

23) Восстановление после ошибки: нет пути «очистить ошибку» (reset), нет переводов с degrade-модой (например, только словарь) при сбое последующих слоев.
- Статус: ◑
- Сделано: reset() добавлен (инкремент 1).
- Шаги реализации: degraded-мода (только словарь/фразы), отчёт в метриках/логах.
- Тесты/критерии: при сбое слой отключается, пайплайн даёт частичный результат.

24) Путь данных по умолчанию: конкатенация строки 'translation_data' к Directory.current.uri.toFilePath() — зависит от хвостового слеша; риск неверного пути; нет проверки доступности/прав.
- Статус: ✔
- Сделано: используем path.join для формирования пути; при инициализации создаём директорию при необходимости; выполняем пробную запись/удаление файла; бросаем EngineInitializationException при сбое.
- Тесты/критерии: предсказуемая работа с путями.

25) Stream lifecycle: factory TranslationEngine.instance(reset: true) вызывает _dispose() без await — гонки.
- Статус: ✖
- Шаги реализации: асинхронное завершение стримов; await перед ресозданием.
- Тесты/критерии: отсутствие гонок/утечек при reset/instance(reset:true).

26) Валидация входа: translate('') возвращает ошибку объектом, но не исключение — неоднородная модель ошибок (где-то исключения, где-то «результат с ошибкой»).
- Статус: ✖
- Шаги реализации: унифицировать ошибки (исключения для фатальных, Result для бизнес-состояний); валидация на границах API.
- Тесты/критерии: предсказуемое поведение на пустых/невалидных входах.

27) Репозитории не нормализуют Unicode (NFC/NFD) глобально; сравнения/ключи завязаны на простое .toLowerCase(), возможны «двойники» и промахи на диакритике.
- Статус: ✖
- Шаги реализации: нормализовать ключи/сравнения/хранилища в NFC.
- Тесты/критерии: корректное сопоставление с диакритикой.

28) Нет версионирования формата данных (schema/version) — невозможна безопасная эволюция JSONL.
- Статус: ✖
- Шаги реализации: добавить версию/схему; миграции; отказ при несовместимой версии.
- Тесты/критерии: миграция старых файлов; корректное поведение при неизвестной версии.

---

## Производительность и масштабируемость

29) Импорт O(n²) и синхронные операции — главный узкий горлышко.
- Статус: ✔
- Сделано: bulk-операции и единичная запись на группу; импортеры на bulk (инкремент 3).
- Тесты/критерии: линейная асимптотика, без порчи данных.

30) Полные индексы в памяти (bySource) без сегментации/шардирования; нет lazy-loading/меммапинга.
- Статус: ✖
- Шаги реализации: сегментация по языковым парам; lazy-load; mmap при необходимости.
- Тесты/критерии: масштабируемость без взрывного роста памяти.

31) Поиск в словаре — простое contains() по строке, отсутствуют индексы/префиксные структуры; фразовый поиск — только exact (пусто для 90% реальных случаев).
- Статус: ◑
- Сделано: n-gram для фраз (инкремент 3).
- Шаги реализации: префиксные структуры для словаря (trie/hash), ускорение lookup.
- Тесты/критерии: ускорение X2+ на больших словарях.

32) Кэш на LRU с TTL не интегрирован в горячую дорожку (ключи, типы записей), фактическая отдача — сомнительна.
- Статус: ◑
- Сделано: LRU+TTL и метрики для generic (инкремент 5).
- Шаги реализации: включить кэш на горячем пути, выровнять ключи/entry-типы.
- Тесты/критерии: рост hit-rate, снижение latency.

33) Нет бенчмарков/метрик слоев — нельзя управлять бюджетом задержек.
- Статус: ◑
- Сделано: базовые метрики (инкремент 5).
- Шаги реализации: бенчмарки engine/слоёв/I-O; экспорт метрик.
- Тесты/критерии: воспроизводимые измерения, регресс-алерты.

---

## Надёжность/устойчивость

34) Нет file-locks/atomic writes — риск порчи данных при конкурентной записи/сбое.
- Статус: ◑
- Сделано: tmp+rename, .lock-файлы (инкремент 3).
- Шаги реализации: fsync и усиление блокировок на критических путях.
- Тесты/критерии: crash-safe запись без частичных файлов.

35) Нет retry/backoff на I/O/сети (download/import).
- Статус: ◑
- Сделано: retry/backoff реализован в DbCommand для HTTP-загрузок; запись идемпотентна через tmp+rename.
- Шаги реализации: расширить retry для других I/O путей при необходимости.
- Тесты/критерии: стабилизация при «флапах», без дублей.

36) Нет механизмов graceful degradation (отключить проблемный слой, fallback к словарю/фразам).
- Статус: ✖
- Шаги реализации: флаги отключения слоёв; fallback-пути; отчёт в метриках.
- Тесты/критерии: сервис остаётся доступным при сбоях слоёв.

37) Нет верификации данных при загрузке (schema validation, поля времени, допустимые пары языков).
- Статус: ✖
- Шаги реализации: schema validation JSONL; карантин битых записей; проверка пар языков.
- Тесты/критерии: чистая база, детальный отчёт о браке.

---

## API/документация/UX

38) Документация обещает CLI и интеграцию, которых нет (нет pubspec/entrypoint).
- Статус: ✖
- Шаги реализации: добавить CLI и обновить документацию; примеры запуска/установки.
- Тесты/критерии: запуск по инструкции.

39) EngineConfig — объявлен и экспортируется, но не действует; ожидания пользователей не будут выполнены.
- Статус: ◑
- Сделано: часть параметров (кэш/логи) применяется (инкремент 5).
- Шаги реализации: довести применение всех ключевых полей; синхронизация с документацией.
- Тесты/критерии: соответствие докам.

40) getCacheInfo/статистика — заглушки; «псевдометрическая» информация вводит в заблуждение при отладке.
- Статус: ✔
- Сделано: реальные метрики generic_* и актуальные лимиты/TTL (инкремент 5).
- Тесты/критерии: метрики соответствуют фактическому состоянию кэша.

---

Примечание: к пунктам с ✔ возвращаемся только при регрессиях; к ◑ — дополняем согласно «Шаги реализации». К ✖ — планируем приоритетно по критичности.
